---
layout:         post
title:          TS-IIS
category:       blog
description:    总结了IIS运维中遇到的常见问题和排查思路
---

## 常用方法

### 监控
- [IIS7.5+配置监控](https://blogs.msdn.microsoft.com/webtopics/2010/03/19/iis-7-5-how-to-enable-iis-configuration-auditing/)
- SSL Binding相关的注册表

		HKLM\System\CurrentControlSet\Services\Http\Parameters\SslBindingInfo\ 
		HKLM\SOFTWARE\Microsoft\SystemCertificates\MY\Certificates
		#这两个会影响SSL bindidng，可以对这两个注册表开启Audit日志，等待问题重现。

## 常用工具

### appcmd
- 路径：**C:\Windows\System32\inetsrvappcmd.exe** `list site`
- IIS配置文件的层级，参考[technet](https://technet.microsoft.com/en-us/library/cc754617(v=ws.10).aspx)
- 默认appcmd写到applicationHost.config（Server Level），我们可以用commit选项手动指定
	- `appcmd list config /section:machineKey /commit:WEBROOT`
	- Root Web.config for the .NET Framework. This file is located in %windir%\Microsoft.NET\Framework\framework_version\CONFIG. 来自于上一个链接[technet](https://technet.microsoft.com/en-us/library/cc754617(v=ws.10).aspx)
	- 参考：[Technet](https://technet.microsoft.com/en-us/library/cc754031%28v=ws.10%29.aspx?f=255&MSPPError=-2147217396)
- 使用参考：
	- [IIS.NET](http://www.iis.net/learn/get-started/getting-started-with-iis/getting-started-with-appcmdexe)
	- [MSDN Blog](https://blogs.msdn.microsoft.com/vivekkum/2009/05/06/iis-77-5-net-configuration-settings-using-appcmd-exe-and-iis-manager/)
- 使用举例：
	- 全局开启日志：`appcmd set config /section:httpLogging /dontLog:False /selectiveLogging:LogAll` 

## 常见问题

### 对WebForm，直接修改ASPX文件
- 直接修改ASPX文件后，w3wp进程会将其编译成App开头的dll，放在临时文件夹下，比如： `C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_mohucqqr.dll`
- 但修改之前的ASPX文件对应的dll依然在w3wp进程的内存中（进程不会重启，AppDomain也不会Unload/Reload，所以Assembly也不会Unload）

		# 修改之前
		0:000> !mex.grep (App)|(Domain) !psscor2.dumpdomain
		System Domain: 000007feea3b4f30
		Name: System Domain
		Shared Domain: 000007feea3b5830
		Name: Shared Domain
		Domain 1: 000000000299efa0
		Name: DefaultDomain
		Domain 2: 0000000002a085b0
		Assembly: 0000000002a863f0 [C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_qaliwxz9.dll]
		000007ff00177b28 C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_qaliwxz9.dll
	
		# 修改之后
		Domain 2: 0000000002a085b0
		Assembly: 0000000002a863f0 [C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_qaliwxz9.dll]
		000007ff00177b28 C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_qaliwxz9.dll
		Assembly: 000000000297f520 [C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_mohucqqr.dll]
		000007ff001f3728 C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_mohucqqr.dll

		# App_Web_qaliwxz9.dll是修改之前的
		# App_Web_mohucqqr.dll是修改之后的

- 如果手动Recylce Application Pool，w3wp进程会重启，PID会变，只会加载`App_Web_mohucqqr.dll`

		Domain 1: 0000000002877c10
		Name: DefaultDomain
		Domain 2: 00000000028dfce0
		Assembly: 00000000029579d0 [C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_mohucqqr.dll]
		000007ff00187b28 C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Temporary ASP.NET Files\root\e22c2559\92c7e946\App_Web_mohucqqr.dll

### SSL证书绑定相关问题
- 一个IIS服务器是否可以绑多张证书?
	- 不同IP或者不同端口随便Bind不影响
	- 同一IP+Port则比较复杂：
		- 在IIS7/7.5，如果给同IP+Port绑2张证书，后绑的会自动替换前面的，多个IP+Port相同的站点只能绑一张证书，如果一个站点先绑了证书，然后证书被删除，UI上就会not-select
		- 如果证书renew，同一张证书到期了，AD/CA自动renew证书，证书信息不变，但是SID变了，也会自动not-select，需要手动重新绑定。
		- 正常情况下，IIS通过IP+Port+Hostname来决定HTTP请求发送到哪个站点，但是SSL时，过程是这样的：
			1. Client – > (SSL Handshake) – > "Hello, I support XYZ algorithm for encryption"
			1. Server -> (SSL Handshake) -> "Hi there, Okay so here is my public certificate. Let's use algorithm X"
			1. Client -> (SSL Handshake)-> "Great we can use that"
			1. Client -> (In Encrypted format)-> "HTTP Request"
			1. Server -> (In Encrypted format)-> "HTTP Response"
		- 所以在SSL过程中，证书是在第2步发出去的，而Hostname是在第4步确定的。在第2步是，IIS只能根据IP+Port来决定发哪个证书给客户端。SNI证书在第一步就表明了Hostname（需要Browser支持，IE7+都支持），IIS8+可以支持SNI证书，所以才能在相同IP+Port的多个站点上绑多张证书。参考[MSDN Blog](https://blogs.msdn.microsoft.com/kaushal/2012/09/04/server-name-indication-sni-with-iis-8-windows-server-2012/)
		- 在IIS7/IIS7.5，多个IP+Port相同的站点只能绑一张证书，那么这张证书可以是WildCard或者SAN类型的，才能适用于多个Hostname不同的站点，参考[MSDN Blog](https://blogs.msdn.microsoft.com/varunm/2013/06/18/bind-multiple-sites-on-same-ip-address-and-port-in-ssl/)
	- 对同一个站点，也可以绑多张证书到不同的Hostname（常用于ARR）

		![testSNICert.png](https://raw.githubusercontent.com/wu-wenxiang/Media-WebLink/master/qiniu/73b815e99c5f428a87de015e7d2e3817-testSNICert.png)

### IIS ApplPool Identity作为WebClient的Credential
- Typo: Client -> WCF(Anonymous Authentication) -> ASMX(Windows Authentication)
- Source
	- Client could be WCFClient, or if use WebForm instead of WCF, web browser is enough
	- ASMX webService could use [`wwxPOC/asp.net_webService_asmx/TestWebServiceHang`](https://github.com/wu-wenxiang/wwxPOC/tree/master/asp.net_webService_asmx/TestWebServiceHang)
	- [WCF Demo](https://github.com/wu-wenxiang/wwxPOC/tree/master/cs_wcf/TestWCFIIS)
- Config
	- WCF/IIS上配置：
		- Anonymous验证，User as AppPool Identity
		- AppPool Identity是一个域帐号即可
	- ASMX webService，需要Windows集成认证
- Reference: Case 268806411380611
	- According to local tests & research, I found we have to modify codes for this case. You can modify this line: `productInfoService.Credentials = new System.Net.NetworkCredential("name", "pwd", "domain");` To: `productInfoService.Credentials = System.Net.CredentialCache.DefaultNetworkCredentials;` I have passed the test in my environment, it should be OK.
	- Why we have to add this line? Refer to [MSDN-defaultnetworkcredentials](https://msdn.microsoft.com/en-us/library/system.net.credentialcache.defaultnetworkcredentials.aspx). Without this line, our default credential is not a network credential, refer to: [MSDN-defaultcredentials](https://msdn.microsoft.com/en-us/library/system.net.credentialcache.defaultcredentials.aspx). This windows local credential does not work for HTTP or FTP protocols.

### IIS Double Hop Issue
- WCF
	- [Source](https://github.com/Adamus7/Double-Hop-WCF-Sample)

### Session Timeout
- Case: 814027417290611
- Symptom
	- 当用户在基于Web的OA系统中写一些内容，过一段时间再保存时，就会一直出现正在保存的画面
	- 如果我关掉正常保存的popup....我刚刚写的内容就会都不见了~
	- 用户在站点上编辑一些内容，过一段时间后（大概20分钟）再保存就会一直在loading的状态，关掉页面后再开页面发现之前输入的内容都已经不见了
- Analysis
	- 初步判断是用户会话（Session）达到默认过期时间（20分钟）导致的
- Solution	
	- 我们可以通过调整这个timeout时间来快速解决这个问题

			<system.web>
			    <sessionState timeout="60"  />
			</system.web>

### 500.19
- Case: 531417416290611
- Symptom: 创建IIS虚拟目录访问web站点报错 HTTP Error 500.19
- Analysis:
	- 客户IIS配置的是共享地址，从错误信息看是运行时的权限不足以读取这个共享文件夹
- Solution
	- 发现问题原因是访问的共享文件夹没有权限，在设置了Application pool用户和Physical path credential用户后，问题解决

## 不常见的问题

### Image过大导致OOM异常
- 用`!address -summary`可以看到Image达到1.7G，MEM_IMAGE达到3.2G，这是个32bit进程，所以容易发生OOM异常
- `!address -f:Image`可以看到，主要是`App_Web_xxxx`吃掉了
- 反编译，可以看到这些东西是Pure的HTML
- 检查配置文件，发现客户把HTML也作为ASP.NET文件进行处理了……
- 修改配置文件，保持HTML文件为static文件，问题解决
