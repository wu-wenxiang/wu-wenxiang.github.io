---
layout:         post
title:          TS-IE
category:       blog
description:    本文小结了若干个不同类型的IE问题，及其对应的排查思路和解决方案。
---

## IE基本知识

关于基本知识，可以参考我写的：[IE11教程](http://blog.wuwenxiang.net/WeKnow-IE11)。

### IE的累积补丁
- 所有产品的最新安全补丁都可以查[这里](https://technet.microsoft.com/zh-cn/security/bulletins)，在搜索框里填写：Internet Explorer，后面写：全部
- 也可以在这里找：https://technet.microsoft.com/library/security/MS16-051
- 或者在google里搜索：IE Cumulative
- Cumulative一般不需要前置补丁，但如果遇到说系统不适用，可以参考[KB 3057448](https://support.microsoft.com/en-us/kb/3057448)，比如在一些比较早的Win8.1（2014年4月之前的）上，就需要先安装KB 2919355

### 卸载IE11
- 参考：[Uninstall-Internet-Explorer-11-for-Windows-7](http://www.wikihow.com/Uninstall-Internet-Explorer-11-for-Windows-7)
- 命令：

		FORFILES /P %WINDIR%\servicing\Packages /M Microsoft-Windows-InternetExplorer-*11.*.mum /c "cmd /c echo Uninstalling package @fname && start /w pkgmgr /up:@fname /norestart"
		FORFILES /P %WINDIR%\servicing\Packages /M Microsoft-Windows-InternetExplorer-*11.*.mum /c "cmd /c echo Uninstalling package @fname && start /w pkgmgr /up:@fname /quiet /norestart"

- IE9也是类似的：
	- 请以管理员权限打开cmd窗口，执行下面的命令卸载IE9

			FORFILES /P %WINDIR%\servicing\Packages /M Microsoft-Windows-InternetExplorer-*9.*.mum /c "cmd /c echo Uninstalling package @fname && start /w pkgmgr /up:@fname /quiet /norestart"

	- 重启电脑，然后再执行一次IE9安装，请从下面的链接下载：[IE9离线安装包](http://windows.microsoft.com/en-us/internet-explorer/ie-9-worldwide-languages)

## 常用工具
- 如果遇到了页面显示空白，或者页面Hang住的问题，首先要Narrow Down是前端的问题，还是对端的问题，标准就是网络包。网络包可以看F12，也可以看HttpWatch，Fiddler，或者Netmon。

### F12-Network

F12中的Network功能可以被认为是HttpWatch+Fiddler的部分功能集。通常用于快速查看网络包的发送和返回。如果要收集数据分析，我们倾向于请客户收集Fiddler，有时候需要HttpWatch。但有一种情况F12比Fiddler要好，就是IE本身就设置了代理的情况。此时如果使用Fiddler，Fiddler的代理会覆盖IE原有的代理，会导致IE不能正常上网。

- Case 752993412170611：

	![F12-Network.png](http://7xudfs.com1.z0.glb.clouddn.com/4d8fa0ac19d8424ca40c1035bd057cc4-F12-Network.png)

	将日志保存成xml格式，然后打开Fiddler，导入xml文件，就可以像Fiddler日志一样方便地查看。

### Fiddler

Fiddler绝对是Narrow Down的神器，他主要分为2个作用：记录请求（无论是Http还是Https），本地重演（AutoReply，支持编辑请求和恢复）

- Case 148843419260611：
	- Symptom
		- 使用Edge访问页面：[http://www.whatarecookies.com/cookietest.asp](http://www.whatarecookies.com/cookietest.asp)
		- 当Edge中的Cookie策略发生变更时，Block -> Don’t Block或者 Don’t Block -> Block，刷新http://www.whatarecookies.com/cookietest.asp页面，内容不变（Cookie Enable/Disable Status）
		- 重启Edge进程，再次访问http://www.whatarecookies.com/cookietest.asp页面，页面内容会随着Edge中Cookie策略设置而变化

	- Analysis
		- 这个检查Cookie的页面逻辑非常复杂，我们需要抽取到最终的某个API才能向产品组报Bug。
		- Fiddler抓包，先撇开其它所有请求，只看第一个asp页面，AutoReply，问题可以重现
		- 基于Fiddler编辑请求的返回，逐渐删减Response Header到至简，删减页面到至简，可以重现问题。
		- 将编辑好的页面保存成一个html页面，在本地不能重现问题。
		- 将这个HTML部署到IIS站点，依然不能重现问题（通过页面逻辑检查下来Cookie总是Enable）。
		- 将这个IIS站点的访问也用Fiddler抓一下，AutoReply，也不能重现问题。
		- 比较Fiddler中的两个AutoReply Rule，发现只有Request URL不一样。
		- 修改IIS站点的请求（不能重现问题的请求）的Request URL为ASP页面请求的同域名请求，问题可以重现！
		- 猜想是Internet Zone和Intranet Zone的区别
		- 使用Internet Zone访问IIS站点（修改客户端的Host文件），问题可以重现！
		- 将原先的www.whatarecookies.com/cookietest.asp加入Intranet Zone，Cookie检查结果总是Enable。
		- 至此，我们找到了Repro Demo
		- 进一步分析代码，在F12 Console里调试，发现是document.cookie的设置逻辑问题，提交Bug给Edge产品组

## 案例小结

### IE11升级失败：IE11log.txt显示前置补丁安装失败
- Case 992335411180611
	- 检查DSIM日志，可以看到报错是：**The package Microsoft-Windows-PlatformUpdate-Win7-SRV08R2-Package-TopLevel is not applicable to the image.**

			2016-08-09 14:17:50, Info                  DISM   DISM Package Manager: PID=8612 Encountered the option "packagepath" with value "Windows6.1-KB2670838-x86.cab" - CPackageManagerCLIHandler::Private_GetPackagesFromCommandLine
			2016-08-09 14:17:50, Info                  DISM   DISM Package Manager: PID=8612 Package Microsoft-Windows-PlatformUpdate-Win7-SRV08R2-Package-TopLevel~31bf3856ad364e35~x86~~7.1.7601.16492 with CBS state 0(CbsInstallStateAbsent) being mapped to dism state 1(DISM_INSTALL_STATE_NOTPRESENT) - CDISMPackage::LogInstallStateMapping
			2016-08-09 14:17:50, Error                 DISM   DISM Package Manager: PID=8612 The package Microsoft-Windows-PlatformUpdate-Win7-SRV08R2-Package-TopLevel is not applicable to the image. - CPackageManagerCLIHandler::Private_ProcessPackageChange
			2016-08-09 14:17:50, Info                  DISM   DISM Package Manager: PID=8612 Initiating Changes on Package with values: 4, 7 - CDISMPackage::Internal_ChangePackageState
			2016-08-09 14:17:50, Info                  DISM   DISM Package Manager: PID=8612  Error in operation: the package is not applicable. (CBS HRESULT=0x800f081e) - CCbsConUIHandler::Error
			2016-08-09 14:17:51, Info                  CSI    00000001 Shim considered [l:252{126}]"\??\C:\Windows\Servicing\x86_microsoft-windows-servicingstack_31bf3856ad364e35_6.1.7600.16385_none_0935b76c289e0fd5\pkgmgr.exe" : got STATUS_OBJECT_PATH_NOT_FOUND
			2016-08-09 14:17:51, Info                  CSI    00000002 Shim considered [l:246{123}]"\??\C:\Windows\WinSxS\x86_microsoft-windows-servicingstack_31bf3856ad364e35_6.1.7600.16385_none_0935b76c289e0fd5\pkgmgr.exe" : got STATUS_SUCCESS
			2016-08-09 14:17:51, Info                  DISM   DISM Package Manager: PID=8612 CBS has requested a shutdown. - 

	- 用IEDigest或者msinfo32收集系统信息，可以看到Windows Versions是：Windows Version: 6.1.7600，而SP1应该是6.1.7601.17514
	- 升级系统到Win7SP1后，问题解决


### 页面显示乱码问题

- 现象和原因
	- 页面显示乱码，或者页面虽然现实正常，但是超链接中的URL是乱码（导致不能正常跳转）
	- 通常选一下Encoding类型页面上就可以正常显示

		![WrongEncode.png](http://7xudfs.com1.z0.glb.clouddn.com/4d8fa0ac19d8424ca40c1035bd057cc4-WrongEncode.png)
	- 对于Href Link，不论是不是http协议，只要URL中的字符不在可见的ASCII码列表中，就应该用%编码。比如：[X:\XXX\XXX_その他\01_XXX通信\2016\6月\XXXXX.MTS](file:///\\yyyyy\yyyyy\yyyyy\XXX\XXX_その他\01_XXX通信\2016\6月\XXXXX.MTS)
	
			<A style="TEXT-ALIGN: left; FONT: 11pt '宋体'; COLOR: #0000ff; VERTICAL-ALIGN: middle; TEXT-DECORATION: underline" href="file:///\\yyyyy\yyyyy\yyyyy\XXX\XXX_その他\01_XXX通信\2016\6月\XXXXX.MTS" target=_blank>X:\XXX\XXX_その他\01_XXX通信\2016\6月\XXXXX.MTS</A>

- 参考
	- 对于local file protocol, [Wiki](https://en.wikipedia.org/wiki/File_URI_scheme) 认为ASCII之外的Unicode字符也需要百分号编码
	
		Unicode characters outside of the ASCII range must be UTF-8 encoded, and those UTF-8 encodings must be percent-encoded.
	
	- Wiki中的论据是[RFC1738](https://tools.ietf.org/html/rfc1738)和[RFC1630](https://tools.ietf.org/html/rfc1630)
	
		1738中2.2节：Octets must be encoded if they have no corresponding graphic
   character within the US-ASCII coded character set.

- 更多
	- URL是区分大小写的
		- 参见[RFC2616](http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html) 
		- 具体：

				3.2.3 URI Comparison
				When comparing two URIs to decide if they match or not, a client SHOULD use a case-sensitive octet-by-octet comparison of the entire URIs, with these exceptions:
				      - A port that is empty or not given is equivalent to the default port for that URI-reference;
				      - Comparisons of host names MUST be case-insensitive;
				      - Comparisons of scheme names MUST be case-insensitive;
				      - An empty abs_path is equivalent to an abs_path of "/".
				Characters other than those in the "reserved" and "unsafe" sets (see RFC 2396 [42]) are equivalent to their ""%" HEX HEX" encoding.
				For example, the following three URIs are equivalent:
					http://abc.com:80/~smith/home.html
					http://ABC.com/%7Esmith/home.html
					http://ABC.com:/%7esmith/home.html
	- 合法字符集
		- 参考[RFC2396](https://www.ietf.org/rfc/rfc2396.txt)
		- 具体：

				  uric          = reserved | unreserved | escaped
			      reserved      = ";" | "/" | "?" | ":" | "@" | "&" | "=" | "+" |
			                      "$" | ","
			      unreserved    = alphanum | mark
			      mark          = "-" | "_" | "." | "!" | "~" | "*" | "'" |
			                      "(" | ")"
				  escaped       = "%" hex hex
			      hex           = digit | "A" | "B" | "C" | "D" | "E" | "F" |
			                              "a" | "b" | "c" | "d" | "e" | "f"
				  alphanum      = alpha | digit
			      alpha         = lowalpha | upalpha
				  lowalpha = "a" | "b" | "c" | "d" | "e" | "f" | "g" | "h" | "i" |
			                 "j" | "k" | "l" | "m" | "n" | "o" | "p" | "q" | "r" |
			                 "s" | "t" | "u" | "v" | "w" | "x" | "y" | "z"
			      upalpha  = "A" | "B" | "C" | "D" | "E" | "F" | "G" | "H" | "I" |
			                 "J" | "K" | "L" | "M" | "N" | "O" | "P" | "Q" | "R" |
			                 "S" | "T" | "U" | "V" | "W" | "X" | "Y" | "Z"
			      digit    = "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" |
			                 "8" | "9"

