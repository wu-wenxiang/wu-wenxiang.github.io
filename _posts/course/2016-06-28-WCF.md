---
layout:         post
title:          WCF
category:       course
description:    介绍WCF的原理，作用，使用方法，以及常见问题的排查思路
---

## QuickStart

### Demo
- [Source](http://github.com/wu-wenxiang/wwxPOC/tree/master/cs_wcf)
- Usage

	![Demo](http://7xudfs.com1.z0.glb.clouddn.com/d051a67046a746a2bc4281098065790d-TestWCF.png)

- Reference
	- MSDN Blog: [How to write a client app that connects to a wcf service](https://blogs.msdn.microsoft.com/brunoterkaly/2013/10/28/wcf-programming-how-to-write-a-client-app-that-connects-to-a-wcf-service/)
	- CodeProject: [Basic WCF Server Client](http://www.codeproject.com/Tips/642296/Hello-World-Basic-Server-Client-Example-of-WCF)
	- WCF Test Client: [WcfTestClient.exe](https://msdn.microsoft.com/en-us/library/bb552364(v=vs.110).aspx)
	- [svcutil.exe](https://msdn.microsoft.com/en-us/library/ms733133(v=vs.110).aspx)
	- [WCF Client Overview](https://msdn.microsoft.com/en-us/library/ms735103(v=vs.110).aspx)

### 重要概念
- [参考](https://www.safaribooksonline.com/library/view/learning-wcf/9780596101626/ch01s03.html)：WCF基于system.servicemodel
- Message Serialization
- Services：
	- 每个Services对应一个实现了service contract接口的.NET类型（通过Apply ServiceContractAttribute）
	- ServiceContractAttribute可以被Apply到接口或者类型上，如果是Apply到接口上，那么实现这个接口的类型都是Service Contract
	- Service Contract中的方法，只有当他们被OperationContractAttribute装饰时，才被认为是组成Service Contract的service operations

		    [ServiceContract]
		    public interface IService1
		    {
		        [OperationContract]
		        string GetData(int value);
		
		        [OperationContract]
		        CompositeType GetDataUsingDataContract(CompositeType composite);
		
		        // TODO: Add your service operations here
		    }

- Hosting：
	- Host Options: 
		- Self-hosting: Console applications, Windows Forms or WPF applications, or Windows services.
		- Internet Information Services (IIS): Services can be hosted alongside other ASP.NET applications.
		- Windows Activation Service (WAS): IIS7+
	- ServiceHost
		- 只有ServiceModel才知道Client发来的消息怎么处理，所有Host进程会通过ServiceHost关联到ServiceType（还有Address和communication protocols），ServiceHost用于初始化和维护communication channels（receive messages to a service）

		        static void Main(string[] args)
		        {
		            Uri url = new Uri("http://localhost:9088/TestService");
		            using (ServiceHost host = new ServiceHost(typeof(TestWCFLib.Service1), url))
		            {
		                host.AddServiceEndpoint(typeof(TestWCFLib.IService1), new WSHttpBinding(), "");
		
		                ServiceMetadataBehavior beh = new ServiceMetadataBehavior();
		                beh.HttpGetEnabled = true;
		
		                host.Description.Behaviors.Add(beh);
		                host.Open();
		
		                Console.WriteLine("Console hosted WCF started");
		                Console.ReadLine();
		            }
		        }

		- 一个ServiceHost可以管理多个Endpoints
- Endpoints
	- When the ServiceHost opens a communication channel for a service, it must expose at least one endpoint for the service so that clients can invoke operations.
	- ABC：Address/Bindings/Contract
- Addresses
	- scheme://domain[:port]/[path]

			net.tcp://localhost:9000
			net.pipe://mymachinename
			http://localhost:8000
			http://www.anydomain.com
			net.msmq://localhost
			
			net.tcp://localhost:9000/ServiceA
			net.pipe://mymachinename/ServiceB
			http://localhost:8000/Services/ServiceA
			http://www.mydomain.com/ServiceA
			net.msmq://localhost/QueuedServices/ServiceA

- Bindings
	- The transport protocol, which can be TCP, named pipes, HTTP, or MSMQ
	- The message encoding format, which determines whether messages are serialized as binary or XML, for example
	- Other messaging protocols related to security and reliability protocols, plus any other custom protocols that affect the contents of the serialized message
- Metadata
	- Information about service endpoints is part of the metadata for a particular service. Clients rely on this metadata to generate proxies to invoke the service
	- Metadata can be accessed in two ways.
		- The ServiceHost can expose a metadata exchange endpoint to access metadata at runtime
		- Or it can be used to generate a WSDL document representing the endpoints and protocols supported by the service. 
	- In either case, clients use tools to generate proxies to invoke the service.
- Proxies
	- Proxy和Endpoint是一对一的关系
	- Proxy可以隐藏序列化和反序列化的实现细节
	- Tools also exist to generate proxies and endpoint configurations from metadata. The ServiceModel Metadata utility tool and Add Service Reference in Visual Studio generates the following WCF client class。[参考](https://msdn.microsoft.com/en-us/library/ms734691%28v=vs.110%29.aspx?f=255&MSPPError=-2147217396)
- Channels
	- The ServiceHost creates a channel listener for each endpoint, which generates a communication channel. 
	- The proxy creates a channel factory, which generates a communication channel for the client. 
	- The channel stack includes a transport channel, a message-encoding channel, and any number of message processing channels for security, reliability, and other features.

		![WCF-Channel](https://www.safaribooksonline.com/library/view/learning-wcf/9780596101626/httpatomoreillycomsourceoreillyimages85082.png)

- Behaviors
	- Behaviors also influence how messages are processed by the service model. While services and endpoints determine the core communication requirements and metadata shared with clients, a behavior modifies the way messages are processed as they flow through the channel stack. Behaviors are local to the client or service—thus, they are not included in metadata.
	- There are behaviors to control many service model features such as exposing metadata, authentication and authorization, transactions, message throttling, and more. Behaviors are enabled either in configuration or by applying behavior attributes to client proxies and services.
	- 参考：[Security Behaviors in WCF](https://msdn.microsoft.com/en-us/library/ms731199(v=vs.110).aspx)

## 深入问题

### WCF如何将进入的请求dispatch到对应的应用程序
- 以Console Application为Host Process的WCF服务为例（本文开头处的Demo）
	- 如果我们关闭WAS（Windows Process Activation Process）服务（会随之关闭依赖到WAS的其它服务，比如World Wide Web Publishing Service，Net.tcp Listener Adapter, Net.Pipe Listener Adapter），我们会发现并不影响Console WCF程序接收/处理消息和返回Response。
	- 用NetStat看，可以看到端口托管是在System进程中

			netstat -anbo
			  TCP    0.0.0.0:9088           0.0.0.0:0              LISTENING       4
			  TCP    [::]:9088              [::]:0                 LISTENING       4

	- Console WCF process必须用admin权限启动，这样他才能在启动时向Http.sys注册endpoint。我们也可以用netsh命令来预先注册url，从而达到用普通用户也可以启动WCF进程的目的。

			netsh http add urlacl url=http://+:8000/Service user=MYDOMAIN\myusername
			netsh http show urlacl

		[参考](http://stackoverflow.com/questions/15531375/wcf-service-self-hosting-service-does-not-work)：For console applications to open up incoming (listening) TCP ports using HTTP.sys (which is what the WCF self-hosted scenario uses), they need either to have administrative privileges, or for some account with an administrative privilege to reserve a "namespace" (i.e., a port/path pair) for specific accounts (or all accounts) to use. 

	- 综上，我们可以看到Dispatch的全过程应该是： http.sys -> console process
	- 如果是IIS托管，那么应该是：http.sys -> WAS -> W3WP
	- 如果不是Http协议绑定，那么WCF会不走http.sys，而是从tcpip.sys直接派发到对应的服务，比如MSMQ/Net.pipe等，然后发送给对应的进程。
		- [参考](http://stackoverflow.com/questions/3548602/wcf-without-http-sys)：WCF HTTP based bindings are dependent on HttpListener class which is managed wrapper around HTTP API. HTTP API is dependent on the way how operation system process http requests. So if you use operation system which uses http.sys driver (Windows 2003 and newer) you are dependent on it.

### 如果WCF消息丢失，如果排查
- 如果是HTTP Binding，可以查http.sys的trace，[参考](https://blogs.msdn.microsoft.com/wndp/2007/01/18/event-tracing-in-http-sys-part-1-capturing-a-trace/)

		logman start httptrace -p Microsoft-Windows-HttpService 0xFFFF -o httptrace.etl -ets

	也可以在insightweb上自己生成
- 如果是其它协议，需要查对应协议的trace（ETL or others）
- [参考](http://www.cnblogs.com/developersupport/p/4158606.html)：	
	- 从IIS7开始，IIS还加入了对非HTTP协议的支持。对于那些采用非HTTP协议，但是又需要部署在IIS里面，从而利用IIS优秀的管理功能的服务来说，比如WCF服务，可谓一大福音。IIS7可以支持多种非HTTP协议，比如net.tcp,net.msmq, net.pipe等。由于HTTP.sys并不会监听非HTTP协议的端口. 对于非HTTP协议, 则有各自的Windows Serivce来进行监听. 例如Net.Tcp协议, 则是由Net.Tcp Port Sharing Service和Net.Tcp Listener Adapter服务进行监听, 并且寄宿在SMSvcHost.exe中.
	- 进过拆分之后, WAS不仅处理HTTP请求，还可以处理非HTTP协议的请求。HTTP请求是由Http.sys截获的，并且在传递给WAS之前，就已经传递给w3svc中的HTTP管理器，但是，其他请求都是通过WAS侦听器的适配器接口转发给配置管理器和进程管理器的，而没有经过w3svc。

### 抓包看Net.tcp对应的TCP capture中的内容

### WinForm等Host进程是如何完成身份验证的？lsass？
- 如果托管在IIS中，身份验证通常是由IIS来完成的（特别是Windows集成认证）
- 其它情况下，身份验证可以由Behaviors来实现，WCF利用了.NET通过的IIdentity三种实现方式：
	- WidnowsIdentity
	- GenericIdentity
	- X509Identity
- 客户端通过代理来传递Credential（进程Account或者指定用户名/密码）
- 服务器端可以模拟用户身份（Impersonation）来执行后续逻辑
- 如果用到了Windows用户的身份验证，一般都是由lsass完成

## 常见问题的排查思路