---
layout:         post
title:          WCF
category:       course
description:    介绍WCF的原理，作用，使用方法，以及常见问题的排查思路
---

## QuickStart

### Demo
- [Source](http://github.com/wu-wenxiang/wwxPOC/tree/master/cs_wcf)
- Usage

	![Demo](http://7xudfs.com1.z0.glb.clouddn.com/d051a67046a746a2bc4281098065790d-TestWCF.png)

- Reference
	- MSDN Blog: [How to write a client app that connects to a wcf service](https://blogs.msdn.microsoft.com/brunoterkaly/2013/10/28/wcf-programming-how-to-write-a-client-app-that-connects-to-a-wcf-service/)
	- CodeProject: [Basic WCF Server Client](http://www.codeproject.com/Tips/642296/Hello-World-Basic-Server-Client-Example-of-WCF)
	- WCF Test Client: [WcfTestClient.exe](https://msdn.microsoft.com/en-us/library/bb552364(v=vs.110).aspx)
	- [svcutil.exe](https://msdn.microsoft.com/en-us/library/ms733133(v=vs.110).aspx)
	- [WCF Client Overview](https://msdn.microsoft.com/en-us/library/ms735103(v=vs.110).aspx)

### 重要概念
- [参考](https://www.safaribooksonline.com/library/view/learning-wcf/9780596101626/ch01s03.html)：WCF基于system.servicemodel
- Message Serialization
- Services：
	- 每个Services对应一个实现了service contract接口的.NET类型（通过Apply ServiceContractAttribute）
	- ServiceContractAttribute可以被Apply到接口或者类型上，如果是Apply到接口上，那么实现这个接口的类型都是Service Contract
	- Service Contract中的方法，只有当他们被OperationContractAttribute装饰时，才被认为是组成Service Contract的service operations

		    [ServiceContract]
		    public interface IService1
		    {
		        [OperationContract]
		        string GetData(int value);
		
		        [OperationContract]
		        CompositeType GetDataUsingDataContract(CompositeType composite);
		
		        // TODO: Add your service operations here
		    }

- Hosting：
	- Host Options: 
		- Self-hosting: Console applications, Windows Forms or WPF applications, or Windows services.
		- Internet Information Services (IIS): Services can be hosted alongside other ASP.NET applications.
		- Windows Activation Service (WAS): IIS7+
	- ServiceHost
		- 只有ServiceModel才知道Client发来的消息怎么处理，所有Host进程会通过ServiceHost关联到ServiceType（还有Address和communication protocols），ServiceHost用于初始化和维护communication channels（receive messages to a service）

		        static void Main(string[] args)
		        {
		            Uri url = new Uri("http://localhost:9088/TestService");
		            using (ServiceHost host = new ServiceHost(typeof(TestWCFLib.Service1), url))
		            {
		                host.AddServiceEndpoint(typeof(TestWCFLib.IService1), new WSHttpBinding(), "");
		
		                ServiceMetadataBehavior beh = new ServiceMetadataBehavior();
		                beh.HttpGetEnabled = true;
		
		                host.Description.Behaviors.Add(beh);
		                host.Open();
		
		                Console.WriteLine("Console hosted WCF started");
		                Console.ReadLine();
		            }
		        }

		- 一个ServiceHost可以管理多个Endpoints
- Endpoints
	- When the ServiceHost opens a communication channel for a service, it must expose at least one endpoint for the service so that clients can invoke operations.
	- ABC：Address/Bindings/Contract
- Addresses
	- scheme://domain[:port]/[path]

			net.tcp://localhost:9000
			net.pipe://mymachinename
			http://localhost:8000
			http://www.anydomain.com
			net.msmq://localhost
			
			net.tcp://localhost:9000/ServiceA
			net.pipe://mymachinename/ServiceB
			http://localhost:8000/Services/ServiceA
			http://www.mydomain.com/ServiceA
			net.msmq://localhost/QueuedServices/ServiceA

- Bindings
	- The transport protocol, which can be TCP, named pipes, HTTP, or MSMQ
	- The message encoding format, which determines whether messages are serialized as binary or XML, for example
	- Other messaging protocols related to security and reliability protocols, plus any other custom protocols that affect the contents of the serialized message
- Metadata
	- Information about service endpoints is part of the metadata for a particular service. Clients rely on this metadata to generate proxies to invoke the service
	- Metadata can be accessed in two ways.
		- The ServiceHost can expose a metadata exchange endpoint to access metadata at runtime
		- Or it can be used to generate a WSDL document representing the endpoints and protocols supported by the service. 
	- In either case, clients use tools to generate proxies to invoke the service.
- Proxies
	- Proxy和Endpoint是一对一的关系
	- Proxy可以隐藏序列化和反序列化的实现细节
	- Tools also exist to generate proxies and endpoint configurations from metadata. The ServiceModel Metadata utility tool and Add Service Reference in Visual Studio generates the following WCF client class。[参考](https://msdn.microsoft.com/en-us/library/ms734691%28v=vs.110%29.aspx?f=255&MSPPError=-2147217396)
- Channels
	- The ServiceHost creates a channel listener for each endpoint, which generates a communication channel. 
	- The proxy creates a channel factory, which generates a communication channel for the client. 
	- The channel stack includes a transport channel, a message-encoding channel, and any number of message processing channels for security, reliability, and other features.

		![WCF-Channel](https://www.safaribooksonline.com/library/view/learning-wcf/9780596101626/httpatomoreillycomsourceoreillyimages85082.png)

- Behaviors
	- Behaviors also influence how messages are processed by the service model. While services and endpoints determine the core communication requirements and metadata shared with clients, a behavior modifies the way messages are processed as they flow through the channel stack. Behaviors are local to the client or service—thus, they are not included in metadata.
	- There are behaviors to control many service model features such as exposing metadata, authentication and authorization, transactions, message throttling, and more. Behaviors are enabled either in configuration or by applying behavior attributes to client proxies and services.
	- 参考：[Security Behaviors in WCF](https://msdn.microsoft.com/en-us/library/ms731199(v=vs.110).aspx)

## 使用方法

## 常见问题的排查思路