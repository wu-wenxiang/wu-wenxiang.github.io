---
layout:         post
title:          WeKnown-IE11
category:       course
description:    IE那些絮叨的历史-IE11升级-常见问题
---

# IE11简介

## Web-Browser简介

### Web-Browser的起源
- 1993年可以被认为是网页浏览器的创始元年。在这一年，Tim Berners Lee在欧洲量子物理实验室创建了万维网。随后，微软的软件工程师开始使用尚未面世但惊艳绝伦的Win95来研发第一代IE。
- 于此同时，伊利诺伊大学（University of Illinois）22岁的大学生Marc Andreessen和他的朋友Eric Bina合写了Mosaic。这是第一个在同视窗中结合了文字与图片的网络浏览器，Mosaic让网页看来变得比较像是印刷品。
- 1994年，Marc将Mosaic重写为Netscape Navigator，该浏览器比之前的Mosaic更快速，更友好。一经推出便很快吃掉了了Web Browser市场70%的份额。
- 1995年夏天，[Netscape](https://en.wikipedia.org/wiki/Netscape)上市，股价从预估的14美元一飞冲天，最高达到75美元，网景的市值达到80亿美元并且拥有浏览器市场90%的份额，一夜之间完成了对可口可乐公司市值一百年积累的赶超。而此时Netscape尚未盈利。
	
### 1st Browser Wars: IE和Netscape的世纪大战
- 1995年，IE1.0随着Win95一起发布。IE1.0的功能并不强大，它不支持Java(Applet)，不支持插件，速度也很慢，不过它有一个最可怕的特点：就是完全免费。Windows 95的用户可以完全免费得到浏览器，于是Netscape不能只比IE好一点，必须要优秀得多，而且永远优秀才能赢得用户。Bill Gates在IE的发布会上，将Internet的崛起称为“IBM生产个人电脑10年以来最重要的发展。” Gates尝试过收购Netscape，但被果断拒绝了，于是一言不合便开打:)
- 在1996年珍珠港事件纪念日，Microsoft邀请了近200名记者和分析家，宣布了公司的Internet的战略：公司从所有方向出击，提供更好，更快，免费的浏览器，并支持Mac，WIN31，WinNT，在NT上提供企业内部网的服务器软件，全部免费的产品包括Netsacpe最主要的产品线，一场残酷的商业战争开始了。Marc认为：“这是一场熊和鳄鱼的搏斗，决定胜负的因素是搏斗的地点，现在Microsoft来到了我们的地盘。”但这次他失算了，Netscape对其它浏览器的技术优势并没有他认为得那么大。
- Windows 95占了PC平台的绝对统治地位，Microsoft的Internet 部门已有超过2500人的队伍，IE3.0的性能已经和Navagator3.0不相上下，同时它依然还有致命的特点：完全免费。Bill Gates向新闻界指出: “ 你们要记住一件事，Microsoft不需要从Internet软件上得到任何收入。” 不幸的是，Netscape需要。双方的实力对比实在太悬殊了。
	
		公司名称    公司年收入 公司市值总量 员工总人数 对公司的影响 
		Microsoft  80亿      1700亿	  20,000    不需要盈利
		Netscape   3亿       20亿        1,000    全部收入来源
	
- Netscape只能要求公正，在1996年8月向联邦政府控告Microsoft采取不正当竞争手段，Microsoft向硬件厂商和Internet接入商提供3美元的折扣，如果他们捆绑IE。Compaq也在97年出示了这些证据，不过政府的调查况日持久。Microsoft遇到了一些麻烦，在美国司法部调查微软违法反托拉斯法时，他的重要合作伙伴Compaq反戈一击，出示了微软强行要求在电脑装上IE，去掉Navagator的证据，美国哥伦比亚地方法官在97年12月11日初审裁定Microsoft不得在操作系统上捆绑IE。
- 但大势已不可逆转，Microsoft在1997年8月发布Internet Explore 4.0，IE已不仅仅是浏览器，IE4.0将作为操作系统的一部分加入新的Win98。Navagator号称拥有3800万用户，而Win95仅在96年销售了6500万份。Microsoft在联机服务和Internet接入商的战场上也取得了成果，美国在线(AOL)宣布他们的用户将使用IE，仅在一天前他们还声称将使用Navagator，Microsoft作为回报将在Win95上放上AOL图标。几天后，CompuServe，AT&T，NETCOM纷纷采用IE。
- 1998年11月网景被美国在线收购，微软向美国在线支付7.50亿美元和解反垄断指控。而美国在线之后又成为时代华纳的一部分。2003年7月15日时代华纳解散网景公司，大部分程序员被解雇，网景的标志也从办公大楼中去除。网景现在只作为一个商标存在。

### 2nd Browser Wars: Chrome vs IE
- 1998年，Netscape在第一次浏览器大战失败后，决定开放源代码，借开源社区的力量继续与IE抗衡。2004年，从Netscape灰烬中浴火重生的Firefox 1.0出世，“第二次浏览器大战”再度展开。但此时IE6的优势依然不可动摇，直至2008年，Chrome横空出世，它性能卓越、界面简洁以及捆绑Google搜寻的优势使其快速流行开来。
- 2015年10月，Android版的Chrome挟着巨大的手机作业系统份额，在[Net Market Share](https://www.netmarketshare.com/browser-market-share.aspx?qprid=0&qpcustomd=0)里超越了Mobile Safari；而在**2016年的5月**，桌面版的Chrome 亦在Net Market Share超越IE。微软在2015年把新一代浏览器命名为“Edge”，因此摊分了IE的分额，但根据Net Market Share的数据，Microsoft Edge12和13只有很少的份额，即使加上这一块，也只能保持轻微优势。如下是**2016年5月**Net Market Share公布的浏览器市场份额数据：

	![IE-Craft.png](http://7xudfs.com1.z0.glb.clouddn.com/b257bb1d42524fbc8013ab5c945d1fc3-IE-Craft.png)
	![IE-Market-Share.png](http://7xudfs.com1.z0.glb.clouddn.com/b257bb1d42524fbc8013ab5c945d1fc3-IE-Market-Share.png)

### Browser的未来
- 在 Chrome追上IE和Mobile Safari的同时，敌人悄悄在行动平台上出现：它就是隐身于统计数据之外的Facebook应用内浏览器(在Android占34.2%、在iOS里占了36.8%)。
- 所以，对Chrome来说，**所谓胜利，只是换了一个对手**。胜利女神没有给Google留下太多时间，Facebook(在中国很可能就是微信和微信公众号)很可能就会成为下一个Chrome。

# IE11的升级
- 分为三步：
	- 安装安装前置补丁
	- 安装IE11离线包
	- [安装IE11安全补丁](https://technet.microsoft.com/zh-cn/security/bulletins)，参考[IE累积补丁](http://blog.wuwenxiang.net/TS-IE)章节

## 检查部署IE11的先决条件
- Internet Explorer 11已默认安装在Windows 8.1和Windows Server 2012 R2中。对于Windows 8和Windows Server 2012，如果要升级Internet Explorer 11，须升级Windows至上述版本。
- Internet Explorer 11支持64位和32位的Windows 7 SP1和Windows Server 2008 R2 SP1。[KB2847882](https://support.microsoft.com/en-us/kb/2847882)列举了在该系统中升级安装Internet Explorer 11所须的先决更新。请在完成安装这些先决更新后（需重启），再安装Internet Explorer 11。
- Internet Explorer 11不支持在Windows Vista/Windows Server 2008及之前版本的Windows上安装。

## 离线安装IE11
- 官方blog [Create an all-inclusive deployment package for Internet Explorer 11](https://support.microsoft.com/en-us/kb/3061428) 中给出的方案是bat脚本，这是比较常见的做法。
- 对于系统windows 2008 R2的SP1包，可以通过命令参数 /quiet /nodialog做静默安装，但是必须要重启后才会生效，所以在一个脚本里面完成SP1升级 + IE11升级是不可行的。[参考网址](https://technet.microsoft.com/en-us/library/cc766219(WS.10).aspx)
- 如果您希望做成一个更便捷的AllInOne的exe可执行文件，可以自己做一个，或者开Case请微软的Support部门帮您定制。

## 通过SCCM 2012部署IE11
	
作为 Microsoft System Center 套件的一部分，System Center 2012 Configuration Manager (SCCM 2012) 为提高企业IT生产力和效率提供了有力的支持。

要安装Internet Explorer 11需要在SCCM 2012中依次执行下面的步骤：
	
1. 下载并许可系统需求和Internet Explorer 11安装包
1. 创建一个包含Internet Explorer 11安装包的软件分发包。
1. 创建一个程序以包含用于运行Internet Explorer 11安装包的命令。
	
	例如下列的命令可用于静默运行安装包，而避免重启Windows或者联网查看更新：`ie11_package.exe /quiet /norestart /update-no`
1. 将安装包移动到您的分发点，然后发放该安装包。

## 通过WSUS部署IE11
	
- Windows Server Update Services (WSUS) 可以协助您在本地WSUS服务器上完成微软产品更新的单次下载和缓存，随后您可以配置您的计算机以从该本地WSUS服务器上获得并安装更新，而不是通过Windows Update。

- 将IE11的更新从Windows Update导入到WSUS
	1. 打开您的WSUS管理站点，例如，http://WSUSServerName/WSUSAdmin/，其中WSUSServerName是您WSUS服务器的主机名
	1. 选择服务器根节点，或者“Update”节点，然后点击Import Updates。
	1. 为了获得更新，需要安装Microsoft Update Catalog ActiveX控件
	1. 搜索Internet Explorer 11并将其内容加入您的篮内（Basket）
	1. 完成后进入篮内并点击Import，如果您期望跳过导入直接下载更新，可以移除“Import directly into Windows Server Update Services”的勾选。

- 在WSUS中签署安装IE11
	1. 打开您的WSUS管理站点并在“To  Do”列表中选择”Review Synchronization Settings”选项
	1. 点击“Synchronize now”以开始将你的WSUS服务与Windows Update同步，然后在导航栏中点击Updates
	1. 在“Search Contains”输入框中输入”Internet Explorer 11“，并点击Apply
	1. 为您的操作系统选择正确的Internet Explorer 11版本，并点击Approve for Installation
	1. 逐个点击您期望的计算机组，选择相应的签署级别，并点击OK

# 升级后IE11遇到的常见问题

## Case 004742319001511:
- 问题现象：IE9升级到IE11后无法打开，IE进程能启动看没有UI界面，退回到IE9后能正常使用
- 问题分析：
	- 首先，这里IE11没有Crash，是Hang在出UI界面的前一步。其次，此问题在IE9中不出现。
	- 可能性1：IE11安装过程中出错
		- 考虑到客户的升级路径是IE8->IE9->IE11，如果真是这种可能，可以卸载IE9，**恢复到出厂版本IE8，然后从IE8->IE11**。
		- 如果问题依然重现，可以收集**IE的安装日志**来检查IE11是否安装过程中有报错？从Windows安装目录下（默认为C:\Windows）收集以下日志文件：
		
				IE11\_main.log
				IE11\_NR\_Setup.log
				IE11\_uninst.log
				cbs*.log
				WU\_ IE11\_LangPacks.log
				WindowsUpdate.log
				logs\CBS\CBS.LOG
	- 可能性2: 第三方插件导致
		- IE11加强了安全性检查，可能导致某些Hook在IE进程中的第三方插件无法正常启动。比如EPM对64位模式对于权限限制更为严格。我们可以检查一下**Procmon日志**，看IE进程运行在什么模式下，是不是有权限相关的报错。
		- 我们也可以尝试以**noaddon模式**启动IE，看问题是否重现。注意，noaddon模式只能排除一部分第三方插件，还有一些插件以非常规的方式Hook到IE的进程中就无法禁用，比如某些安全卫士。
			- Click Start -> All Programs -> Accessories -> System Tools
			- Then click Internet Explorer (No Add-ons)
		- 如果在Windows启动时按F8进入安全模式，那么几乎所有的第三方插件都会被禁用，这也是一个快速定位是否第三方插件导致IE问题的方案。但往往定位到问题在哪一方还远远不够，解决问题才是对客户有价值的思考方向，再加上进入安全模式比较麻烦，所以一般我们不会首先使用这个方法来Narrow Down问题。
	- 然而：
		- IE9->IE8，IE8->IE11，**问题依然重现**
		- IE安装日志，**升级成功，没有异常**

			`Setup exit code: 0x00000BC2 (3010) - Installation Succeeded.`
		
		- Procmon日志，**没有发现明显异常**
		- NoAddon模式测试，**问题依然重现**
	- 禁用LCIE，使用ProcDump收集Hang Dump
	- 分析Dump，发现是第三方插件造成了Hang
- 解决方案：卸载第三方软件，问题解决。

## 不能执行已释放script的代码
- 问题现象：IE8可以正常访问页面，IE11访问页面时报错：不能执行已释放script的代码
- 问题分析：调试代码，发现JavaScript代码的Bug
- 解决方案：修复客户代码

## MIME问题
- 问题现象：IE8上可以正常运行的VBScript代码，在IE11上不能运行
- 问题分析：分析网络包，发现MIME类型异常
- 解决方案：修改服务端，代码，使其符合设计

## IE不能正常访问应用页面
- 问题现象：企业内网的IE11不能正常访问应用页面，Chrome可以正常访问
- 问题分析：检查文档模式，发现使用了IE7模式
- 解决方案：调整组策略，去掉兼容性视图

## IE11上传文件句柄持有问题
- Case 699514414170611
	- Symptom
		- IE11普通上传控件，上传Excel，在点击上传时会做Excel格式检查，格式不对时会退出上传。但不清空Input file控件内容，在修改了Excel内容后，点击上传，IE获取的是旧的内容。 IE8时正常，IE11时获得旧内容
	- Analysis: 
		- 这个行为是IE的By-Design行为，从IE10开始有的，所以客户之前IE8中是正常工作的。原因是在做File upload时，IE浏览器会保持住这个被选择文件的句柄，此时对这个文件的修改删除都不会报错，但是内部机制是这些新的修改是放在一个临时的隐藏文件中，而IE浏览器上传控件此时的句柄仍然指向的是旧的文件。详情请参考[文档](https://connect.microsoft.com/IE/feedback/details/817183/ie10-and-ie11-keep-files-locked-after-uploading)。
	- Solution:
		- 已验证即使我们代码里清空File upload控件内容也无法释放文件句柄，只有页面刷新，或者一个完整的POST行为后才会释放句柄。建议我们下一步可以根据这个页面的实现机制更改代码，选择如下一种行为：
			- 在验证格式失败返回后，强制刷新页面。
			- 清空File upload控件值，并reset整个form，验证可以在IE11中释放这个文件句柄。类似如下代码：

					document.getElementById("fileUpload1").value = "";
					document.getElementById("form1").reset();

## Case: 001806411380611
- Symptom
	- IE11打开https://www.google.com/
	- F12打开开发人员工具，切换到Console页
	- 输入`document.write('hello')`，会得到如下的错误提示: `SEC7111: HTTPS security is compromised by (null)`
- Conclusion
	- 这是一个已知[Bug](https://connect.microsoft.com/IE/feedback/details/863891/ie11-https-security-is-compromised-message-is-shown-in-console-when-a-https-page-is-loaded-in-iframe)
- WorkAround-1
	- 对于空链接或者锚，比如`<a href="" name="an">`，建议改成`href="#"`或者`href="javascript:"`
	- 主页面是HTTPS的时候，iframe中不要使用HTTP的链接，建议可以改成相对路径（同个站点下）
	- 对于JS的windows.open函数，不要使用空地址，使用相对地址或者HTTPS地址
- WorkAround-2
	- 如页面样式和JS代码兼容IE8文档模式，建议更改页面metadata，使用IE8模式渲染页面，则不会出现这个问题

# Extend
- [Training-IE11-Edge-Public](https://github.com/wu-wenxiang/Training-IE11-Edge-Public)